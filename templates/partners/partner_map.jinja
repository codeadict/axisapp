{% extends "page.jinja" %}


{% block content %}
  <div class="row" id="maprow">
    <div class="col-md-12 height-css">
      <div id="map"></div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{{ "libs/js/leaflet-hash.js"|static }}"></script>
  <script src="{{ 'js/Control.FullScreen.js'|static }}"></script>
  <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
  <script src="http://matchingnotes.com/javascripts/leaflet-google.js"></script>


  <script>
  //https://gist.github.com/raw/4504864/c9ef880071f959398b7cf0b687d4f37c352ea86d/leaflet-google.js

    var areasurl = "{{  url('poligonos_data') }}";
    var dataurl = "{{  url('clients_data') }}";

    var defaultStyle = {
      color: "#2262CC",
      weight: 2,
      opacity: 0.6,
      fillOpacity: 0.1,
      fillColor: "#2262CC"
    };

    var highlightStyle = {
      color: '#2262CC',
      weight: 3,
      opacity: 0.6,
      fillOpacity: 0.65,
      fillColor: '#2262CC'
    };

    var onEachArea = function (feature, layer) {
      // All we're doing for now is loading the default style.
      layer.setStyle(defaultStyle);

      (function (layer, properties) {
        // Create a mouseover event
        layer.on("mouseover", function (e) {
          // Change the style to the highlighted version
          layer.setStyle(highlightStyle);
          // Create a popup with a unique ID linked to this record
          var popup = $("<div></div>", {
            id: "popup-" + properties.id,
            css: {
              position: "absolute",
              bottom: "85px",
              left: "50px",
              zIndex: 1002,
              backgroundColor: "white",
              padding: "8px",
              border: "1px solid #ccc"
            }
          });
          // Insert a headline into that popup
          var hed = $("<div></div>", {
            text: "Area: " + properties.nombre + ' Cantidad de Clientes: ' + properties.total_clientes,
            css: {fontSize: "16px", marginBottom: "3px"}
          }).appendTo(popup);
          // Add the popup to the map
          popup.appendTo("#map");
        });
        // Create a mouseout event that undoes the mouseover changes
        layer.on("mouseout", function (e) {
          // Start by reverting the style back
          layer.setStyle(defaultStyle);
          // And then destroying the popup
          $("#popup-" + properties.id).remove();
        });
        // Close the "anonymous" wrapper function, and call it while passing
        // in the variables necessary to make the events work the way we want.
      })(layer, feature.properties);
    };

    function onEachFeature(feature, layer) {
      if (feature.properties) {
        layer.bindPopup(feature.properties.popupContent);
      }
    }

    $.getJSON(dataurl, function (data) {
      // Add GeoJSON layer
      var clients = L.geoJson(data, {onEachFeature: onEachFeature});

      var map = L.map('map', {
        fullscreenControl: true,
        fullscreenControlOptions: {
          position: 'topleft',
          forceSeparateButton: true
        }
      }).fitBounds(clients.getBounds());


      var googleSat = new L.Google('SATELLITE');
      map.addLayer(googleSat);

      clients.addTo(map);

      $.getJSON(areasurl, function (data) {
        // Add GeoJSON layer
        L.geoJson(data, {onEachFeature: onEachArea}).addTo(map);
      });

      var hash = new L.Hash(map);

    });


  </script>
{% endblock %}
